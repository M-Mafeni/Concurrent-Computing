//nestedpar.xc
#include <platform.h>
#include <stdio.h>

void taskA(chanend c[n], unsigned n) {
  int serving = 1;
  int counter = 0;
  while (serving)
    select {
      case c[int j] :> int data:
        printf("channel %d gets %d\n",j,data);
        c[j] <: data;
        if (data == 0) counter++;
        if (counter == n) serving = 0;
        break;
} }

void taskB(chanend c, chanend d) {
  int data1, data2;
  par {
    { d <: 1; d :> data1; }
    { c <: 2; c :> data2; }
  }
  par {
    { d <: 0; d :> data1; }
    { c <: 0; c :> data2; }
  }
}

int main() {
  chan c[4];
  par {
    on tile[0]: taskA(c,4);
    on tile[0]: taskB(c[0],c[1]);
    on tile[1]: taskB(c[2],c[3]);
  }
  return 0;
}
