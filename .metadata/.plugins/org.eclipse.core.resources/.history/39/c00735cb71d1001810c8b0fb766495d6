//shutdowncounter.xc
#include <platform.h>
#include <stdio.h>

void taskA(chanend c[n], unsigned n) {
  int serving = 1;
  int counter = 0;
  while (serving)
    select {
      case c[int j] :> int data:
        printf("channel %d receives %d\n",j,data);
        c[j] <: data;
        if (data == 0) counter++;
        if (counter == 4) serving = 0;
        break;
} }

void taskB(chanend c) {
  int data;
  c <: 1;
  c :> data;
  c <: 0;
  c :> data;
}

int main() {
  chan c[4];
  par {
    on tile[0]: taskA(c,4);
    on tile[0]: taskB(c[0]);
    on tile[0]: taskB(c[1]);
    on tile[1]: taskB(c[2]);
    on tile[1]: taskB(c[3]);
  }
  return 0;
}
