//deadlock2.xc
#include <platform.h>
#include <stdio.h>

void taskA(chanend c[n], unsigned n) {
  int serving = 1;
  while (serving)
    select {
      case c[int j] :> int data:
        printf("channel %d gets %d\n",j,data);
        c[j] <: data;
        if (data == 0) serving = 0;
        break;
} }

void taskB(chanend c, chanend d, int terminate) {
  int data;
  c <: 1;
  c :> data;
  c <: 2;
  c :> data;
  if (terminate == 1) {
      d :> data;
      c <: 0;
      c :> data;
  } else d <: 0;
}

int main() {
  chan c[4],d,e;
  par {
    on tile[0]: taskA(c,4);
    on tile[0]: taskB(c[0],e,1);
    on tile[0]: taskB(c[1],e,0);
    on tile[1]: taskB(c[2],d,1);
    on tile[1]: taskB(c[3],d,0);
  }
  return 0;
}
